// Multibanco Payment - JavaScript com Timer

(function () {
    'use strict';

    // Timer de 24 horas
    let timeLeft = 24 * 60 * 60; // 86400 segundos
    const timerDisplay = document.getElementById('timer');

    // Gerar referência Multibanco
    function generateReference() {
        const ref = Math.floor(100000000 + Math.random() * 900000000);
        const formattedRef = ref.toString().match(/.{1,3}/g).join(' ');
        document.getElementById('mbReference').textContent = formattedRef;

        // Calcular validade
        const now = new Date();
        const validity = new Date(now.getTime() + 24 * 60 * 60 * 1000);
        const day = validity.getDate().toString().padStart(2, '0');
        const month = (validity.getMonth() + 1).toString().padStart(2, '0');
        const hours = validity.getHours().toString().padStart(2, '0');
        const minutes = validity.getMinutes().toString().padStart(2, '0');
        document.getElementById('mbValidity').textContent = `${day}/${month} ${hours}:${minutes}`;
    }

    generateReference();

    function updateTimer() {
        const hours = Math.floor(timeLeft / 3600);
        const minutes = Math.floor((timeLeft % 3600) / 60);
        const seconds = timeLeft % 60;

        timerDisplay.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

        if (timeLeft <= 0) {
            // Timer expirado
            clearInterval(timerInterval);
            showExpired();
            return;
        }

        // Mudar cor quando estiver abaixo de 1 hora
        if (timeLeft <= 3600) {
            timerDisplay.style.color = '#DC2626';
        }

        timeLeft--;
    }

    // Iniciar timer
    const timerInterval = setInterval(updateTimer, 1000);
    updateTimer();

    function showExpired() {
        const statusCard = document.querySelector('.status-card');
        statusCard.innerHTML = `
            <div class="status-icon" style="background: rgba(239, 68, 68, 0.1); border-color: rgba(239, 68, 68, 0.3);">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#EF4444" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/>
                    <line x1="15" y1="9" x2="9" y2="15"/>
                    <line x1="9" y1="9" x2="15" y2="15"/>
                </svg>
            </div>
            <h1 class="status-title">Referência Expirada</h1>
            <p class="status-subtitle">A referência Multibanco expirou. Por favor, gera uma nova referência.</p>
            <button onclick="window.location.href='./checkout.html'" style="
                margin-top: 20px;
                padding: 12px 24px;
                background: linear-gradient(135deg, #10B981, #059669);
                color: white;
                border: none;
                border-radius: 8px;
                font-size: 14px;
                font-weight: 600;
                cursor: pointer;
            ">Voltar ao Checkout</button>
        `;
    }

    // Simular confirmação de pagamento após 15 segundos (para teste)
    setTimeout(() => {
        clearInterval(timerInterval);
        showSuccess();
    }, 15000);

    function showSuccess() {
        const statusCard = document.querySelector('.status-card');
        statusCard.innerHTML = `
            <div class="status-icon" style="background: rgba(16, 185, 129, 0.1); border-color: rgba(16, 185, 129, 0.3);">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#10B981" stroke-width="2">
                    <path d="M22 11.08V12a10 10 0 11-5.93-9.14"/>
                    <polyline points="22 4 12 14.01 9 11.01"/>
                </svg>
            </div>
            <h1 class="status-title">Pagamento Confirmado!</h1>
            <p class="status-subtitle">Estás a ser redirecionado para o teu acesso...</p>
        `;

        // Guardar dados e redirecionar
        sessionStorage.setItem('accessGranted', 'true');
        setTimeout(() => {
            window.location.href = './direct.html';
        }, 2000);
    }

    // Capturar dados da URL
    const urlParams = new URLSearchParams(window.location.search);
    const amount = urlParams.get('amount') || '12,90€';

    console.log('Multibanco Payment - Amount:', amount);
})();
