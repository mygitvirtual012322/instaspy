// Checkout Minimalista - JavaScript

(function () {
    'use strict';

    // Elementos
    const form = document.getElementById('checkoutForm');
    const submitBtn = document.getElementById('submitBtn');
    const paymentStatus = document.getElementById('paymentStatus');
    const phoneInput = document.getElementById('phone');
    const mbwayPhoneInput = document.getElementById('mbwayPhone');
    const paymentTabs = document.querySelectorAll('.payment-tab');
    const paymentContents = document.querySelectorAll('.payment-content');
    const statusIcon = document.getElementById('statusIcon');

    let selectedPaymentMethod = 'mbway';

    // SVG Icons
    const icons = {
        loading: '<circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/>',
        mbway: '<rect x="5" y="2" width="14" height="20" rx="2" ry="2"/><line x1="12" y1="18" x2="12" y2="18"/>',
        success: '<path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/>',
        error: '<circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/>'
    };

    // Máscara de telemóvel português (9XX XXX XXX)
    function formatPhoneNumber(input) {
        let value = input.value.replace(/\D/g, '');
        if (value.length > 9) value = value.substring(0, 9);

        if (value.length > 6) {
            value = value.substring(0, 3) + ' ' + value.substring(3, 6) + ' ' + value.substring(6);
        } else if (value.length > 3) {
            value = value.substring(0, 3) + ' ' + value.substring(3);
        }

        input.value = value;
    }

    // Aplicar máscara aos campos de telemóvel
    if (phoneInput) {
        phoneInput.addEventListener('input', function () {
            formatPhoneNumber(this);
        });
    }

    if (mbwayPhoneInput) {
        mbwayPhoneInput.addEventListener('input', function () {
            formatPhoneNumber(this);
        });

        // Copiar telemóvel principal para MBWay automaticamente
        phoneInput.addEventListener('input', function () {
            if (!mbwayPhoneInput.value) {
                mbwayPhoneInput.value = this.value;
            }
        });
    }

    // Troca de método de pagamento
    paymentTabs.forEach(tab => {
        tab.addEventListener('click', function () {
            const method = this.dataset.method;

            // Atualizar tabs
            paymentTabs.forEach(t => t.classList.remove('active'));
            this.classList.add('active');

            // Atualizar conteúdo
            paymentContents.forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(method + '-content').classList.add('active');

            selectedPaymentMethod = method;

            // Se for Multibanco, gerar referência
            if (method === 'multibanco') {
                generateMultibancoReference();
            }
        });
    });

    // Gerar referência Multibanco
    function generateMultibancoReference() {
        const mbRef = document.getElementById('mbRef');
        const mbReference = document.getElementById('mbReference');
        const mbValidity = document.getElementById('mbValidity');

        // Gerar referência aleatória
        const ref = Math.floor(100000000 + Math.random() * 900000000);
        const formattedRef = ref.toString().match(/.{1,3}/g).join(' ');

        mbReference.textContent = formattedRef;

        // Calcular validade (24h a partir de agora)
        const now = new Date();
        const validity = new Date(now.getTime() + 24 * 60 * 60 * 1000);
        const hours = validity.getHours().toString().padStart(2, '0');
        const minutes = validity.getMinutes().toString().padStart(2, '0');
        mbValidity.textContent = `${hours}:${minutes}`;

        mbRef.style.display = 'block';
    }

    // Validar formulário
    function validateForm() {
        const fullName = document.getElementById('fullName').value.trim();
        const email = document.getElementById('email').value.trim();
        const phone = document.getElementById('phone').value.replace(/\D/g, '');

        if (fullName.length < 3) {
            alert('Por favor, insere o teu nome completo.');
            return false;
        }

        if (!email.match(/^[^\s@]+@[^\s@]+\.[^\s@]+$/)) {
            alert('Por favor, insere um email válido.');
            return false;
        }

        if (phone.length !== 9) {
            alert('Por favor, insere um número de telemóvel válido (9 dígitos).');
            return false;
        }

        // Validar MBWay se selecionado
        if (selectedPaymentMethod === 'mbway') {
            const mbwayPhone = mbwayPhoneInput.value.replace(/\D/g, '');
            if (mbwayPhone.length !== 9) {
                alert('Por favor, insere o número de telemóvel MBWay (9 dígitos).');
                return false;
            }
        }

        return true;
    }

    // Atualizar ícone SVG
    function updateIcon(iconType) {
        if (statusIcon) {
            statusIcon.innerHTML = icons[iconType] || icons.loading;
        }
    }

    // Processar MBWay
    function processMBWay() {
        const mbwayPhone = mbwayPhoneInput.value.replace(/\D/g, '');
        const email = document.getElementById('email').value;

        // Guardar dados
        sessionStorage.setItem('userEmail', email);
        sessionStorage.setItem('mbwayPhone', mbwayPhone);

        // Redirecionar para página de pagamento MBWay
        window.location.href = `./mbway-payment.html?phone=${mbwayPhone}&amount=12,90€`;
    }

    // Processar Multibanco
    function processMultibanco() {
        const email = document.getElementById('email').value;

        // Guardar dados
        sessionStorage.setItem('userEmail', email);

        // Redirecionar para página de pagamento Multibanco
        window.location.href = `./multibanco-payment.html?amount=12,90€`;
    }

    // Mostrar status de pagamento
    function showStatus(title, message) {
        document.getElementById('statusTitle').textContent = title;
        document.getElementById('statusMessage').textContent = message;

        form.style.display = 'none';
        paymentStatus.classList.add('show');
    }

    // Processar sucesso
    function processSuccess() {
        updateIcon('success');
        showStatus('Pagamento Confirmado', 'Estás a ser redirecionado para o teu acesso...');

        // Guardar dados de acesso
        const email = document.getElementById('email').value;
        sessionStorage.setItem('userEmail', email);
        sessionStorage.setItem('accessGranted', 'true');

        // Redirecionar após 2 segundos
        setTimeout(() => {
            window.location.href = './direct.html';
        }, 2000);
    }

    // Submit do formulário
    form.addEventListener('submit', async function (e) {
        e.preventDefault();

        if (!validateForm()) {
            return;
        }

        // Processar pagamento (redireciona para página dedicada)
        if (selectedPaymentMethod === 'mbway') {
            processMBWay();
        } else {
            processMultibanco();
        }
    });

    // Capturar parâmetros da URL
    const urlParams = new URLSearchParams(window.location.search);
    const plan = urlParams.get('plan');

    console.log('Checkout carregado. Plano:', plan || 'vitalicio');
})();
