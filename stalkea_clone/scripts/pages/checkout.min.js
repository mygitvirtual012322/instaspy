// Checkout Minimalista - JavaScript

(function () {
    'use strict';

    // Elementos
    const form = document.getElementById('checkoutForm');
    const submitBtn = document.getElementById('submitBtn');
    const paymentStatus = document.getElementById('paymentStatus');
    const phoneInput = document.getElementById('phone');
    const mbwayPhoneInput = document.getElementById('mbwayPhone');
    const paymentTabs = document.querySelectorAll('.payment-tab');
    const paymentContents = document.querySelectorAll('.payment-content');
    const statusIcon = document.getElementById('statusIcon');

    let selectedPaymentMethod = 'mbway';

    // SVG Icons
    const icons = {
        loading: '<circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/>',
        mbway: '<rect x="5" y="2" width="14" height="20" rx="2" ry="2"/><line x1="12" y1="18" x2="12" y2="18"/>',
        success: '<path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/>',
        error: '<circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/>'
    };

    // M√°scara de telem√≥vel portugu√™s (9XX XXX XXX)
    function formatPhoneNumber(input) {
        let value = input.value.replace(/\D/g, '');
        if (value.length > 9) value = value.substring(0, 9);

        if (value.length > 6) {
            value = value.substring(0, 3) + ' ' + value.substring(3, 6) + ' ' + value.substring(6);
        } else if (value.length > 3) {
            value = value.substring(0, 3) + ' ' + value.substring(3);
        }

        input.value = value;
    }

    // Aplicar m√°scara aos campos de telem√≥vel
    if (phoneInput) {
        phoneInput.addEventListener('input', function () {
            formatPhoneNumber(this);
        });
    }

    if (mbwayPhoneInput) {
        mbwayPhoneInput.addEventListener('input', function () {
            formatPhoneNumber(this);
        });

        // ‚úÖ Copiar telem√≥vel principal para MBWay automaticamente EM TEMPO REAL
        phoneInput.addEventListener('input', function () {
            // Sempre copiar o telefone principal para o MBWay
            mbwayPhoneInput.value = this.value;

            // Adicionar feedback visual
            if (this.value.replace(/\D/g, '').length === 9) {
                mbwayPhoneInput.style.borderColor = '#10B981';
                mbwayPhoneInput.style.backgroundColor = 'rgba(16, 185, 129, 0.05)';
            }
        });

        // Preencher automaticamente ao carregar se j√° houver telefone salvo
        if (phoneInput.value) {
            mbwayPhoneInput.value = phoneInput.value;
        }
    }

    // Troca de m√©todo de pagamento
    paymentTabs.forEach(tab => {
        tab.addEventListener('click', function () {
            const method = this.dataset.method;

            // Atualizar tabs
            paymentTabs.forEach(t => t.classList.remove('active'));
            this.classList.add('active');

            // Atualizar conte√∫do
            paymentContents.forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(method + '-content').classList.add('active');

            selectedPaymentMethod = method;

            // üé® Aplicar cores APENAS nos CARDS de pagamento
            const mbwayTab = document.querySelector('[data-method="mbway"]');
            const multibancoTab = document.querySelector('[data-method="multibanco"]');

            if (method === 'mbway') {
                // MBWay = Vermelho
                mbwayTab.style.borderColor = '#E53E3E';
                mbwayTab.style.background = 'rgba(229, 62, 62, 0.1)';
                mbwayTab.style.color = '#E53E3E';

                // Resetar Multibanco
                multibancoTab.style.borderColor = '';
                multibancoTab.style.background = '';
                multibancoTab.style.color = '';
            } else if (method === 'multibanco') {
                // Multibanco = Azul
                multibancoTab.style.borderColor = '#3B82F6';
                multibancoTab.style.background = 'rgba(59, 130, 246, 0.1)';
                multibancoTab.style.color = '#3B82F6';

                // Resetar MBWay
                mbwayTab.style.borderColor = '';
                mbwayTab.style.background = '';
                mbwayTab.style.color = '';
            }

            // ‚ùå N√ÉO gerar refer√™ncia no checkout - s√≥ na p√°gina individual
        });
    });

    // Validar formul√°rio
    function validateForm() {
        const fullName = document.getElementById('fullName').value.trim();
        const email = document.getElementById('email').value.trim();
        const phone = document.getElementById('phone').value.replace(/\D/g, '');

        if (fullName.length < 3) {
            alert('Por favor, insere o teu nome completo.');
            return false;
        }

        if (!email.match(/^[^\s@]+@[^\s@]+\.[^\s@]+$/)) {
            alert('Por favor, insere um email v√°lido.');
            return false;
        }

        if (phone.length !== 9) {
            alert('Por favor, insere um n√∫mero de telem√≥vel v√°lido (9 d√≠gitos).');
            return false;
        }

        // Validar MBWay se selecionado
        if (selectedPaymentMethod === 'mbway') {
            const mbwayPhone = mbwayPhoneInput.value.replace(/\D/g, '');
            if (mbwayPhone.length !== 9) {
                alert('Por favor, insere o n√∫mero de telem√≥vel MBWay (9 d√≠gitos).');
                return false;
            }
        }

        return true;
    }

    // Atualizar √≠cone SVG
    function updateIcon(iconType) {
        if (statusIcon) {
            statusIcon.innerHTML = icons[iconType] || icons.loading;
        }
    }

    // Processar MBWay
    async function processMBWay() {
        const fullName = document.getElementById('fullName').value.trim();
        const email = document.getElementById('email').value.trim();
        const nif = document.getElementById('nif').value.trim();
        const mbwayPhone = mbwayPhoneInput.value.replace(/\D/g, '');

        try {
            // Mostrar loading
            showStatus('A processar pagamento...', 'Aguarda um momento...', 'loading');

            // Criar transa√ß√£o via WayMB
            const result = await WayMBService.createTransaction({
                amount: 12.90,
                method: 'mbway',
                payer: {
                    name: fullName,
                    document: nif,
                    phone: mbwayPhone
                }
            });

            if (result.success) {
                // Guardar dados da transa√ß√£o
                sessionStorage.setItem('currentPayment', JSON.stringify(result.data));
                sessionStorage.setItem('userEmail', email);
                sessionStorage.setItem('mbwayPhone', mbwayPhone);

                // Redirecionar para p√°gina de confirma√ß√£o
                window.location.href = `./mbway-payment.html?tx=${result.data.id}`;
            } else {
                throw new Error(result.error || 'Erro ao processar pagamento');
            }
        } catch (error) {
            console.error('Erro MBWay:', error);
            showStatus('Erro no Pagamento', error.message, 'error');
            setTimeout(() => {
                paymentStatus.style.display = 'none';
            }, 3000);
        }
    }

    // Processar Multibanco
    async function processMultibanco() {
        const fullName = document.getElementById('fullName').value.trim();
        const email = document.getElementById('email').value.trim();
        const nif = document.getElementById('nif').value.trim();
        const phone = phoneInput.value.replace(/\D/g, '');

        try {
            // Mostrar loading
            showStatus('A processar pagamento...', 'Aguarda um momento...', 'loading');

            // Criar transa√ß√£o via WayMB
            const result = await WayMBService.createTransaction({
                amount: 12.90,
                method: 'multibanco',
                payer: {
                    name: fullName,
                    document: nif,
                    phone: phone
                }
            });

            if (result.success) {
                // Guardar dados da transa√ß√£o
                sessionStorage.setItem('currentPayment', JSON.stringify(result.data));
                sessionStorage.setItem('userEmail', email);

                // Redirecionar para p√°gina de confirma√ß√£o
                window.location.href = `./multibanco-payment.html?tx=${result.data.id}`;
            } else {
                throw new Error(result.error || 'Erro ao processar pagamento');
            }
        } catch (error) {
            console.error('Erro Multibanco:', error);
            showStatus('Erro no Pagamento', error.message, 'error');
            setTimeout(() => {
                paymentStatus.style.display = 'none';
            }, 3000);
        }
    }

    // Mostrar status de pagamento
    function showStatus(title, message) {
        document.getElementById('statusTitle').textContent = title;
        document.getElementById('statusMessage').textContent = message;

        form.style.display = 'none';
        paymentStatus.classList.add('show');
    }

    // Processar sucesso
    function processSuccess() {
        updateIcon('success');
        showStatus('Pagamento Confirmado', 'Est√°s a ser redirecionado para o teu acesso...');

        // Guardar dados de acesso
        const email = document.getElementById('email').value;
        sessionStorage.setItem('userEmail', email);
        sessionStorage.setItem('accessGranted', 'true');

        // Redirecionar ap√≥s 2 segundos
        setTimeout(() => {
            window.location.href = './direct.html';
        }, 2000);
    }

    // Submit do formul√°rio
    form.addEventListener('submit', async function (e) {
        e.preventDefault();

        if (!validateForm()) {
            return;
        }

        // Processar pagamento (redireciona para p√°gina dedicada)
        if (selectedPaymentMethod === 'mbway') {
            processMBWay();
        } else {
            processMultibanco();
        }
    });

    // Capturar par√¢metros da URL
    const urlParams = new URLSearchParams(window.location.search);
    const plan = urlParams.get('plan');

    // üé® Aplicar cores ao carregar a p√°gina (MBWay j√° vem selecionado)
    const mbwayTab = document.querySelector('[data-method="mbway"]');
    if (mbwayTab && mbwayTab.classList.contains('active')) {
        mbwayTab.style.borderColor = '#E53E3E';
        mbwayTab.style.background = 'rgba(229, 62, 62, 0.1)';
        mbwayTab.style.color = '#E53E3E';
    }

    console.log('Checkout carregado. Plano:', plan || 'vitalicio');
})();
